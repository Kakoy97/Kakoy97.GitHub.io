---
layout:     post
title: "Opiniflow开发日志：如何逆向“黑盒”，打造积分分析雷达"
date: 2026-01-01
author:     "Kakoy"
header-img: "img/home-bg-geek.jpg"
mathjax:    true
catalog:    true
categories: [Web3, 实战复盘]
tags: [System Design, Data Analysis, FIFO, Web3]
description: "从用户痛点出发，深度解析如何通过 FIFO 队列算法清洗乱序交易流，构建五维雷达图，破解积分获取的“黑盒”逻辑"
---

# Opiniflow进化论：我不止想给你看数据，还想给你请位“AI分析师”

首先很开心 **Opiniflow** 获得了 Opinion 黑客松首届赞助项目！🎉

刚开始参与比赛时，我更多是奔着“把自己所需的工具分享给他人使用”的心态，顺便拿个赞助。但当网站上线，每日活跃用户稳定在 100～300 人之间时，这份心态转化成了责任。

看着推特粉丝量的增多，收到用户反馈说网站帮他们优化了策略，这让我收获了成就感。

## 01. 拒绝“伪需求”的自我感动

**用户到底需要什么？这是我开发新功能时问自己最多的问题。**

如果不先考虑自身或用户在流程中的痛点，那开发出的需求往往是“伪需求”，是开发者的自嗨。如果单纯为了堆砌功能，简单调用几个 API 显示一堆无关紧要的数据，这有帮助吗？可能有，但那是用伪需求堆砌起来的虚假壁垒。

站在用户的视角，用户使用预测市场的核心诉求只有两个：
1.  **盈利**（搞钱）。
2.  **获取积分**（积分在未来 TGE 时会转化成奖励，本质也是盈利）。

Opinion 的积分计算公式是一个“黑盒”，官方文档只给了模糊的方向。要破解这个黑盒，首先要明确哪些行为会影响积分？查阅文档并结合实战经验，我总结了以下五个核心维度：
1.  **交易规模**：买入卖出的总量。
2.  **盈利能力**：不仅要刷量，还要赚钱（ROI）。
3.  **持仓时间**：拿得越久，积分权重可能越高。
4.  **挂单方式**：分为市价和限价，限价要求尽可能去提供流动性，因此挂单价格越靠近成交价，并且越久。积分比重越高。
5.  **奖励市场**：参与官方指定的 Boost 市场。

## 02. 技术深水区：为什么 API 数据不能直接用？

当我准备着手开发时，遇到了一个巨大的技术坑：API 给的数据是“流水账”。

官方 API 返回的 raw_trades 只是简单的买入（Buy）和卖出（Sell）记录。它不会告诉你：

你卖出的这一单，对应的是哪一次买入？

这笔持仓到底拿了多久？（Duration）

你现在的实际持仓成本是多少？

这就好比玩 RPG 游戏，背包里有一堆药水，有 10 金币买的，有 20 金币买的。当你喝掉一瓶时，API 只告诉你“喝了一瓶”，却没告诉你喝的是便宜的那瓶还是贵的那瓶。

如果不解决这个问题，“持仓时间”和“精确 ROI”就无法计算。

### 核心算法：FIFO 库存管理队列

为了解决这个难题，我引入了会计学和库存管理中常用的 FIFO（先进先出）算法。我将整个数据处理流程重构为类似游戏服务器的"即时结算系统"。

我在后端设计了一个 InventoryManager（库存管理器），它的工作流如下：

```mermaid
graph TD
    API["原始 API 数据"] --> Raw["Raw Trades 表"]
    Raw --> Queue{"FIFO 匹配引擎"}
    
    subgraph Engine [Inventory Manager]
        Queue -- "买入 (Buy)" --> In(("入库队列"))
        Queue -- "卖出 (Sell)" --> Out{"队列判定"}
        Out -- "有库存?" --> Match["生成 Matched Trade"]
        Out -- "无库存?" --> Ext["标记为 External"]
    end
    
    Match --> Stats["计算持仓时间 & PnL"]
    Stats --> DB[("存入 Weekly Stats 表")]
```

### 分片处理：跨周持仓的切割

这个算法最复杂的地方在于分片（Slicing）。因为积分是按周结算的，我必须把跨周的持仓切开：

* **TRADED**：买入->卖出（形成了闭环）。
* **CARRYING**：剩余未卖出的部分（这是未结持仓）。
* **SETTLED**：之前持有，直到过去某个时间点结算的部分。

通过递归处理**所有历史交易数据**，我终于把散乱的"流水"清洗成了清晰的"持仓明细"。现在，可以清楚的划分哪些交易类型在哪一周进行发生，以什么形式结束。

## 03. 数据可视化：五维雷达图

数据清洗完毕后，如何展示给用户？我不想给用户看 Excel 表格，我希望用户一眼就能看出自己的短板。

于是，我设计了这个**"五维策略雷达"**。基于之前的需求分析，我将清洗后的数据映射到了五个维度：

![img](/img/opiniflow/opiniflow_wuzhan.png)
*(图：Opiniflow 五维策略雷达)*

#### 交易规模 (Trade Scale)

**逻辑**：基于 `total_volume` 在全网 Top 100 用户的排名。

#### 盈利能力 (Profitability)

**逻辑**：基于 ROI (投资回报率)。

**痛点**：刷分的人往往亏钱刷，而高质量用户是赚钱刷。

#### 积分获取 (Points Efficiency)

**逻辑**：这是最硬核的指标——Cost Per Point（每分成本）。

**意义**：同样的 1000 分，你花了 10U 手续费，别人只花了 1U，说明别人的策略更优。这个维度能直接帮用户省钱。

#### 持仓时间 (Holding Time)

**逻辑**：利用上面提到的 FIFO 算法计算出的 `avg_duration_seconds`。

**发现**：通过数据分析，我发现长期持有（Long-term Holding）在某些权重下比高频刷单更有优势。

#### 奖励市场 (Reward Market)

**逻辑**：`designated_trades_ratio`。简单直接，你是否参与了官方指定的 Boost 市场？

## 04. 标签系统：给交易员打上“人设”Tag

在 RPG 游戏里，我们通过属性给角色分类：坦克、法师、刺客。在交易市场里，每个人的行为模式也大相径庭。

为了让数据更直观，我开发了一套**自动标签系统**。系统会根据聚合后的数据，自动识别那些"显眼包"行为：

* 🐳 **Whales (巨鲸)**：`Top Volume` / `Top Profit`。资金量巨大或者盈利最多的头部玩家。
* ⚡ **Flash Traders (刷分机器人)**：持仓时间极短。大概率是高频刷分机器。
* 💎 **Long Term Holders (钻石手)**：持仓时间很长。
* 🦅 **Early Birds (早鸟)**：在市场创建 2 小时内就冲进去的人。这是风险最高、也是潜在收益最高的群体。
* 🏭 **Makers (做市商)**：挂单交易者（Fee <= 0）。

这些 Tag 不仅展示给用户看，更是接下来喂给 AI 的关键"提示词"。

## 05. 注入灵魂：聘请一位“首席情报分析师”

以前的工具只告诉你“你赚了多少钱”。现在的 Opiniflow，我想让它告诉你**“你是什么样的交易员”**，以及**“你的对手是什么段位”**。

我接入了 Gemini，并进行了一次深度的解析。

### S-Tier 评分系统

为了让报告更能一眼看出该用户的定位，我让 AI 输出一个 **S-Tier 到 F-Tier** 的评级：

通过之前回溯的数据，以及筛选有特征、有代表性的标签化的交易记录，可以对用户的交易行为、积分获取方式进行第三方深度侧写报告输出。

![img](/img/opiniflow/opiniflow_fenxi.png)
*(图：Opiniflow AI侧写报告)*

